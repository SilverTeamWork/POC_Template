<!--
The `sp-rating` element exposes silverpeas rating functionality.

    <sp-rating
        appid="blog2"
        contributionid="58"
        readonly></sp-rating>

With `readonly` set to `true`, the element only display current user rating and don't allow
user to interact with
-->

<dom-module id="sp-rating">
  <style>
    .silverpeas-rating {
      display: inline-flex;
      vertical-align: middle;
    }

    .silverpeas-rating img {
      width: 16px !important;
      height: 16px !important;
      border: none;
      cursor: pointer;
    }
  </style>
  <template>
    <sp-service-ajax
        id="ratingFetcher"
        path="{{ratingUri}}"
        on-response="_handleResponse"
        debounce-duration="300">
    </sp-service-ajax>
    <sp-service-ajax
        id="ratingPusher"
        path="{{ratingUri}}"
        contentType="text/plain"
        method="POST"
        on-response="_handleResponse"
        debounce-duration="300">
    </sp-service-ajax>
    <div id="ratingContainer" class="silverpeas-rating">
      <template is="dom-repeat" items="[[_stars]]" as="star">
        <img class$="[[star.classes]]"
             title$="[[star.title]]" alt$="[[star.note]]" src$="[[star.url]]"
             on-mouseout="onMouseOut" on-mouseenter="onMouseEnter" on-click="onMouseClick"/>
      </template>
      <template is="dom-if" if="{{_isRatingStarDeleteToDisplay(rating)}}">
        <img id="ratingStarDelete" class="silverpeas-rating-note silverpeas-rating-note-unselected"
             src="../../images/rating/star_delete2.png" title="Supprimer mon avis"
             on-click="onMouseClick"/>
      </template>
    </div>
  </template>
</dom-module>

<script>
  (function() {

    var __starTitles = ['Mauvais', 'Passable', 'Assez bien', 'Bien', 'TrÃ¨s bien'];

    var DEFAULT_RATING_NOTE_STYLE = "silverpeas-rating-note";
    var UNSELECTED_RATING_NOTE_STYLE = "silverpeas-rating-note-unselected";
    var SELECTED_RATING_NOTE_STYLE = "silverpeas-rating-note-selected";
    var HALF_SELECTED_RATING_NOTE_STYLE = "silverpeas-rating-note-half";
    var HOVER_RATING_NOTE_STYLE = "silverpeas-rating-note-hover";

    var NOTE_SELECTED_SRC = "../../images/rating/star.png";
    var NOTE_HALF_SELECTED_SRC = "../../images/rating/star_half.png";
    var NOTE_UNSELECTED_SRC = "../../images/rating/star_empty.png";
    var NOTE_HOVER_SRC = "../../images/rating/red_star.png";
    var NOTE_CLEAR_RATING_SRC = "../../images/rating/star_delete2.png";

    Polymer({
      is : 'sp-rating', behaviors : [SessionBehavior], properties : {
        /**
         * if true, user can only view current contribution rating
         * if false, user can modify its own contribution rating
         */
        readonly : {
          type : Boolean, value : false
        },

        /**
         * the current application identifier
         */
        appid : {
          type : String
        },

        /**
         * the current contribution identifier
         */
        contributionid : {
          type : String
        },

        ratingUri : {
          type : String, computed : '_computeRatingUri(appid, contributionid)'
        },

        rating : {
          type : Object, notify : true
        },

        _hoverRatingNote : {
          type : Number, value : 0, notify : true
        },

        onHovered : {
          type : Event
        },

        _stars : {
          type : Array, notify : true, value : function() {
            var stars = [];
            __starTitles.forEach(function(starLabel, index) {
              stars.push({
                classes : DEFAULT_RATING_NOTE_STYLE + ' ' + UNSELECTED_RATING_NOTE_STYLE,
                url : '../../images/rating/star_empty.png',
                title : starLabel,
                note : (index + 1)
              });
            });
            return stars;
          }
        }
      },

      created : function() {
        NOTE_SELECTED_SRC = this.resolveUrl(NOTE_SELECTED_SRC);
        NOTE_HALF_SELECTED_SRC = this.resolveUrl(NOTE_HALF_SELECTED_SRC);
        NOTE_UNSELECTED_SRC = this.resolveUrl(NOTE_UNSELECTED_SRC);
        NOTE_HOVER_SRC = this.resolveUrl(NOTE_HOVER_SRC);
        NOTE_CLEAR_RATING_SRC = this.resolveUrl(NOTE_CLEAR_RATING_SRC);
      },

      _computeRatingUri : function(appid, contributionid) {
        return "rating/" + this.appid + "/Publication/" + this.contributionid;
      },

      ready : function() {
        if (this.appid != undefined) {
//          console.log('sp-rating element ready appid=' + this.appid + " and contributionId = " +
//              this.contributionid);
          this._retrieveContributionRating();
        }
      },

      /**
       * This method retrieve current contribution rating
       */
      _retrieveContributionRating : function() {
        // Get rating from ajax call (xml http request)
        this.$.ratingFetcher.send();
      },

      _handleResponse : function(event) {
        // Handle rating ajax response
        this.rating = event.detail.response;
//        console.log('Retrieve rating from ' + this.appid + ' and contribution ' +
//            this.contributionid);
        this._render(this.rating);
      },

      hovered : false, unsetHoverRatingNote : function() {
        this._hoverRatingNote = 0;
      },

      /**
       * Handle on mouse over event on targeted image
       * @param e the event
       */
      onMouseEnter : function(e) {
        this.hovered = true;
        e.preventDefault();
        e.stopPropagation();
        if (!this.readonly) {
          var curImageTarget = e.target;
          this._hoverRatingNote = parseInt(curImageTarget.alt);
          this._render(this.rating);
        }
      },

      /**
       * Handle on mouse out event on targeted image
       * @param e the event
       */
      onMouseOut : function(e) {
        this.hovered = false;
        e.preventDefault();
        e.stopPropagation();
        if (!this.readonly) {
          this.unsetHoverRatingNote();
          this._render(this.rating);
        }
      },

      /**
       * Handle on mouse click event on targeted image
       * @param e the event
       */
      onMouseClick : function(e) {
        console.log('onMouseClick : register new user rating');
        e.preventDefault();
        e.stopPropagation();
        if (!this.readonly) {
          var curImageTarget = e.target;
          this.unsetHoverRatingNote();
          if (curImageTarget == this.$.ratingStarDelete) {
            this.postNewRating(null);
          } else {
            this.postNewRating(parseInt(curImageTarget.alt));
          }
        }
      },

      /**
       * Indicates if the given rating must be displayed.
       */
      _isRatingStarDeleteToDisplay : function(rating) {
        return !this.readonly && rating && rating.isRatingDone && rating.raterRatingValue != 0
      },

      /**
       * Render graphical display of the rating given in parameter
       * @param rating the rating to display
       */
      _render : function(rating) {
        var ratingNote = rating.numberOfRaterRatings > 0 ? rating.ratingAverage :
            rating.raterRatingValue;
        if (Math.ceil(ratingNote) != ratingNote) {
          ratingNote += 1;
        }
        var ratingContainer = Polymer.dom(this.$.ratingContainer);
        var ceil = Math.ceil(ratingNote);
        this._stars.forEach(function(star, index) {
          var note = index + 1;
          var img = ratingContainer.querySelector("img[alt='" + note + "']");

          var resource = '';
          var style = '';
          if (rating != null) {
            if (this._hoverRatingNote == 0) {
              if (note <= ratingNote) {
                if (ceil != ratingNote && note == (ceil - 1)) {
                  var rounded = Math.round(ratingNote);
                  if (Math.abs(ratingNote - rounded) > 0.25) {
                    resource = NOTE_HALF_SELECTED_SRC;
                    style = HALF_SELECTED_RATING_NOTE_STYLE;
                  } else {
                    resource = NOTE_UNSELECTED_SRC;
                    style = UNSELECTED_RATING_NOTE_STYLE;
                  }
                } else {
                  resource = NOTE_SELECTED_SRC;
                  style = SELECTED_RATING_NOTE_STYLE;
                }
              } else {
                resource = NOTE_UNSELECTED_SRC;
                style = UNSELECTED_RATING_NOTE_STYLE;
              }
            } else {
              if (note <= this._hoverRatingNote) {
                resource = NOTE_HOVER_SRC;
                style = HOVER_RATING_NOTE_STYLE;
              } else {
                resource = NOTE_UNSELECTED_SRC;
                style = UNSELECTED_RATING_NOTE_STYLE;
              }
            }
          } else {
            resource = NOTE_UNSELECTED_SRC;
            style = UNSELECTED_RATING_NOTE_STYLE;
          }
          star.url = resource;
          star.classes = DEFAULT_RATING_NOTE_STYLE + ' ' + style;
          this.notifyPath('_stars.' + index + '.url', star.url);
          this.notifyPath('_stars.' + index + '.classes', star.classes);
        }.bind(this));
      },

      /**
       * Post a new rating on the current rating component identified by appid an contributionid
       * @param note the note to set
       */
      postNewRating : function(note) {
        console.log('postNewRating for appid=' + this.appid + " and contributionId = " +
            this.contributionid + ' with value =' + note);
        this.rating.raterRatingValue = note;
        // Get rating from ajax call (xml http request)
        this.$.ratingPusher.body = note ? note : '';
        this.$.ratingPusher.contentType = 'text/plain';
        this.$.ratingPusher.send();
      }
    });
  })();
</script>

