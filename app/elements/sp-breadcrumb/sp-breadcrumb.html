<link rel="import" href="../sp-space/sp-space-libs.html">
<link rel="import" href="../sp-application/sp-app-libs.html">

<dom-module id="sp-breadcrumb">
  <style>
    :host .content {
      display: inline-flex;
    }
  </style>
  <template>
    <nav class="breadcrumb">
      <div class="content">
        <a href="[[getSpacePageUrl(homeSpace)]]" class="home-breadcrumb">[[homeSpace.label]]</a>
        <template is="dom-repeat" items="[[spaces]]" as="space" restamp="true">
          <a href="[[getSpacePageUrl(space)]]" class="space-breadcrumb" on-click="_spaceBreadcrumbClicked">[[space.label]]</a>
        </template>
        <template is="dom-if" if="[[isValidApplicationInstance(applicationInstance)]]" restamp="true">
          <a href="[[getApplicationInstancePageUrl(applicationInstance)]]" class="app-breadcrumb" on-click="_appBreadcrumbClicked">[[applicationInstance.label]]</a>
        </template>
        <template is="dom-if" if="[[page]]" restamp="true">
          <a href="[[page.url]]" class="app-page-breadcrumb" on-click="_pageBreadcrumbClicked">[[page.label]]</a>
        </template>
      </div>
      <template is="dom-if" if="[[_backButtonDisplayed]]" restamp="true">
        <div id="backContainer" class="back">
          <a title="Retour à la page précédente" href="#" on-click="_backButtonClicked">Retour à la
            page précédente</a>
        </div>
      </template>
    </nav>
  </template>
</dom-module>
<script>
  (function() {

    Polymer({
      is : 'sp-breadcrumb',

      behaviors : [SpaceBehavior, ApplicationInstanceBehavior, NavigationContextBehavior],

      properties : {

        context : {
          type : Object
        },

        spaces : {
          type : Array, value : function() {
            return [];
          }
        },

        applicationInstance : {
          type : Object
        },

        page : {
          type : Object
        },

        _backButtonDisplayed : false
      },

      observers : ['_spaceChanged(context.space)', '_instanceChanged(context.instance)',
        '_pageChanged(context.page.label)'],

      _spaceBreadcrumbClicked : function(e) {
        e.preventDefault();
        e.stopPropagation();

        var index = e.model.__key__;
        var sliceIndex = -1;
        if (this.isValidApplicationInstance(this.applicationInstance)) {
          sliceIndex = index + 1;
        } else if ((index + 1) < this.spaces.length) {
          sliceIndex = index;
        }

        if (sliceIndex > -1) {
          page(this.getSpacePageUrl(this.spaces[index]));
        }
      },

      _spaceChanged : function() {
        if (this.context.space) {
          this.async(function() {
            this.applicationInstance = null;
            this.page = null;
            this._pushSpaces(this.context.space);
            this._backButtonDisplayed = (this.spaces.length > 1);
          }.bind(this));
        }
      },

      _appBreadcrumbClicked : function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (this.pages.length) {
          page(this.getApplicationInstancePageUrl(this.applicationInstance));
        }
      },

      _instanceChanged : function() {
        if (this.context.instance) {
          this.async(function() {
            this.page = null;
            this._pushApplicationInstance(this.context.instance);
            this._backButtonDisplayed = true;
          }.bind(this));
        }
      },

      _pageBreadcrumbClicked : function(e) {
        e.preventDefault();
        e.stopPropagation();
      },

      _pageChanged : function() {
        this.async(function() {
          this._pushPage(this.context.path, this.context.page);
          this._backButtonDisplayed = true;
        }.bind(this));
      },

      _pushSpaces : function(childSpace) {
        if (childSpace != null && childSpace) {

          // Getting the space path
          var spacePath = [];
          var currentSpace = childSpace;
          while (currentSpace) {
            spacePath.unshift(currentSpace);
            currentSpace = currentSpace.parentSpace;
          }

          // Making a copy of spaces and initializing temporary variables
          var modified = false;
          var spaces = [].concat(this.spaces);
          if (spaces.length > spacePath.length) {
            modified = true;
            spaces = spaces.slice(0, spacePath.length);
          }

          // Merging the breadcrumb according to computed space path
          spacePath.forEach(function(space, index) {
            if (spaces.length > index) {
              if (space.uri != spaces[index].uri) {
                modified = true;
                spaces[index] = space;
              }
            } else {
              modified = true;
              spaces.push(space);
            }
          });

          // Updating the breadcrumb if a modification has been performed
          if (modified) {
            this.spaces = spaces;
          }

        } else {
          this.spaces = [];
        }
      },

      _pushApplicationInstance : function(applicationInstance) {
        if (this.isValidApplicationInstance(applicationInstance)) {
          this._pushSpaces(applicationInstance.parentSpace);
          this.applicationInstance = applicationInstance;
        } else {
          this._pushSpaces(null);
          this.applicationInstance = null;
        }
      },

      _pushPage : function(path, page) {
        if (page) {
          if (page.label) {
            this.page = {url : path, label : page.label};
          }
        } else {
          this.page = null;
        }
      },

      _backButtonClicked : function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (this.page) {
          page(this.getApplicationInstancePageUrl(this.applicationInstance));
          return;
        }

        var length = this.spaces.length;
        if (this.applicationInstance) {
          page(this.getSpacePageUrl(this.spaces[length - 1]));
        } else if (length > 1) {
          page(this.getSpacePageUrl(this.spaces[length - 2]));
        }
      }
    });
  })();
</script>