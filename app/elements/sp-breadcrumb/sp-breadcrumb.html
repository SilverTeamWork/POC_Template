<link rel="import" href="../sp-space/sp-space-libs.html">
<link rel="import" href="../sp-application/sp-app-libs.html">

<dom-module id="sp-breadcrumb">
  <template>
    <nav class="breadcrumb">
      <div class="content">
        <a href="{{getSpacePageUrl(homeSpace)}}" class="home-breadcrumb">{{homeSpace.label}}</a>
        <template is="dom-repeat" items="{{spaces}}" as="space" restamp="true">
          <a href="{{getSpacePageUrl(space)}}" class="space-breadcrumb" on-click="_spaceBreadcrumbClicked">{{space.label}}</a>
        </template>
        <template is="dom-if" if="{{isValidApplicationInstance(applicationInstance)}}" restamp="true">
          <a href="{{getApplicationInstancePageUrl(applicationInstance)}}" class="app-breadcrumb" on-click="_appBreadcrumbClicked">{{applicationInstance.label}}</a>
        </template>
        <template is="dom-repeat" items="{{pages}}" as="page" restamp="true">
          <a href="{{page.url}}" class="app-page-breadcrumb">{{page.label}}</a>
        </template>
      </div>
    </nav>
  </template>
</dom-module>
<script>
  (function() {

    Polymer({
      is : 'sp-breadcrumb',

      behaviors : [SpaceBehavior, ApplicationInstanceBehavior],

      properties : {

        context : {
          type : Object
        },

        spaces : {
          type : Array, notify : true, value : function() {
            return [];
          }
        },

        applicationInstance : {
          type : Array, notify : true
        },

        pages : {
          type : Array, notify : true, value : function() {
            return [];
          }
        }
      },

      observers : ['_spaceChanged(context.space)', '_instanceChanged(context.instance)',
        '_pageChanged(context.page.label)'],

      _spaceBreadcrumbClicked : function() {
        this.applicationInstance = null;
        this.pages = [];
      },

      _spaceChanged : function() {
        this._pushSpaces(this.context.space);
        this._spaceBreadcrumbClicked();
      },

      _appBreadcrumbClicked : function() {
        this.pages = [];
      },

      _instanceChanged : function() {
        this._pushApplicationInstance(this.context.instance);
        this._appBreadcrumbClicked();
      },

      _pageChanged : function() {
        this._pushPage(this.context.page);
      },

      _pushSpaces : function(childSpace) {
        this.async(function() {
          if (childSpace != null && childSpace) {

            // Getting the space path
            var spacePath = [];
            var currentSpace = childSpace;
            while (currentSpace) {
              spacePath.unshift(currentSpace);
              currentSpace = currentSpace.parentSpace;
            }

            // Making a copy of spaces and initializing temporary variables
            var modified = false;
            var spaces = [].concat(this.spaces);
            if (spaces.length > spacePath.length) {
              modified = true;
              spaces = spaces.slice(0, spacePath.length);
            }

            // Merging the breadcrumb according to computed space path
            spacePath.forEach(function(space, index) {
              if (spaces.length > index) {
                if (space.uri != spaces[index].uri) {
                  modified = true;
                  spaces[index] = space;
                }
              } else {
                modified = true;
                spaces.push(space);
              }
            });

            // Updating the breadcrumb if a modification has been performed
            if (modified) {
              this.spaces = spaces;
            }

          } else {
            this.spaces = [];
          }
        }.bind(this));
      },

      _pushApplicationInstance : function(applicationInstance) {
        this.async(function() {
          if (this.isValidApplicationInstance(applicationInstance)) {
            this._pushSpaces(applicationInstance.parentSpace);
            this.applicationInstance = applicationInstance;
          } else {
            this._pushSpaces(null);
            this.applicationInstance = [];
          }
        });
      },

      _pushPage : function() {
        this.async(function() {
          if (this.context.page) {
            var pages = [].concat(this.pages);
            while (pages.length > 0) {
              var currentPage = pages.pop();
              if (currentPage.url === this.context.path) {
                break;
              }
            }
            pages.push({url : this.context.path, label : this.context.page.label});
            this.pages = pages;
          }
        });
      }
    });
  })();
</script>