<link rel="import" href="../sp-space/sp-space-libs.html"/>
<link rel="import" href="../sp-application/sp-app-libs.html"/>

<dom-module id="sp-space-header-menu">
  <template>
    <sp-service-ajax path="spaces"
                     last-response="{{spaces}}"
                     auto></sp-service-ajax>
    <nav>
      <ul>
        <li>
          <a href="{{getSpacePageUrl(homeSpace)}}">{{homeSpace.label}}</a>
          <sp-space-menu-content id="spaceHomepage" space="[[homeSpace]]"></sp-space-menu-content>
        </li>
        <template is="dom-repeat" items="[[spaces]]">
          <li>
            <a href="{{getSpacePageUrl(item)}}">{{item.label}}</a>
            <sp-space-menu-content space="[[item]]"></sp-space-menu-content>
          </li>
        </template>
      </ul>
    </nav>
  </template>
</dom-module>
<script>
  (function() {

    Polymer({
      is : 'sp-space-header-menu',

      behaviors : [SpaceBehavior, ApplicationInstanceBehavior],

      properties : {

        spaces : {
          type : Array, notify : true, observer : '_spacesLoaded'
        },

        context : {
          type : Object
        }
      },

      observers : ['_spaceChanged(context.space.model)', '_applicationInstanceChanged(context.instance.model)'],

      created : function() {
        this._whenReady_ = new Promise(function(resolve, reject) {
          this.resolveCompletes = resolve;
          this.rejectCompletes = reject;
        }.bind(this));
      },

      _spacesLoaded : function() {
        this.resolveCompletes(this);
      },

      _spaceChanged : function() {
        this._lastAccessedAreaChanged(this.context.space.model);
      },

      _applicationInstanceChanged : function() {
        this._lastAccessedAreaChanged(this.context.instance.model);
      },

      _lastAccessedAreaChanged : function(area) {
        if (area && area !== null) {
          this._getRootSpace(area, function(rootSpace) {
            this._markAsSelected(rootSpace);
          }.bind(this));
        } else {
          this._markAsSelected(null);
        }
      },

      _markAsSelected : function(lastAccessedSpace) {
        this._whenReady_.then(function() {

          // Clearings the current selection
          Polymer.dom(this.root).querySelectorAll('sp-space-menu-content').forEach(function(item) {
            item.parentNode.classList.remove('selected');
          });

          // Guess the new one
          if (lastAccessedSpace !== null && this.homeSpace.id === lastAccessedSpace.id) {

            // Home space
            this.$.spaceHomepage.parentNode.classList.add('selected');

          } else if (this.isValidSpace(lastAccessedSpace)) {

            // Valid space
            Polymer.dom(this.root).querySelectorAll('sp-space-menu-content').forEach(function(item) {
              if (item.space.id === lastAccessedSpace.id) {
                item.parentNode.classList.add('selected');
              }
            });

          } else {
            // Space that does not exist
          }
        }.bind(this));
      }
    });
  })();
</script>
