<script>
  (function() {
    window.SpaceBehavior = {

      properties : {
        homeSpace : {
          type : Object,
          notify : true,
          readOnly : true,
          value : {"type" : "space", "id" : "-1", "label" : "Home sweet home"}
        },

        unknownSpace : {
          type : Object, notify : true, readOnly : true, value : {}
        }
      },

      /**
       * Get the root space from the given space uri.
       * @param spaceUri a space uri.
       * @param callback the called callback with root space as parameter if any.
       * @private
       */
      _getRootSpaceFromSpaceUri : function(spaceUri, callback) {
        SilverpeasServiceAjaxBehavior.newSilverpeasServiceAjax().onResponse(function(e) {
          var space = e.detail.response;
          this._getRootSpace(space, callback);
        }.bind(this)).get(spaceUri);
      },

      /**
       * Get the root space from the given space or instance.
       * @param spaceOrInstance a space or an instance (actually needs parentURI attribute).
       * @param callback the called callback with root space as parameter if any.
       * @private
       */
      _getRootSpace : function(spaceOrInstance, callback) {
        this._loadParentSpaces(spaceOrInstance, function() {
          var rootSpace = spaceOrInstance;
          while (rootSpace.parentSpace) {
            rootSpace = rootSpace.parentSpace;
          }
          callback.call(this, rootSpace);
        }.bind(this));
      },

      /**
       * Loads the parent space recursively from a given space or instance.
       * @param spaceOrInstance a space or an instance (actually needs parentURI attribute).
       * @param callback the called callback with given instance as parameter.
       * @private
       */
      _loadParentSpaces : function(spaceOrInstance, callback) {
        if (spaceOrInstance && spaceOrInstance !== null) {
          if (!spaceOrInstance.parentURI) {
            callback.call(this, spaceOrInstance);
          } else {
//            console.log("SpaceBehavior._loadParentSpaces " + spaceOrInstance.uri);
            if (spaceOrInstance.parentSpace) {
//              console.log("--> but space linked to following parent uri is already cached " +
//                  spaceOrInstance.parentSpace.uri);
              this._loadParentSpaces(spaceOrInstance.parentSpace, callback);
            } else {
              SilverpeasServiceAjaxBehavior.newSilverpeasServiceAjax().onResponse(function(e) {
                var parentSpace = e.detail.response;
//                console.log("--> space linked to following parent uri is loaded " +
//                    parentSpace.uri);
                spaceOrInstance.parentSpace = parentSpace;
                this._loadParentSpaces(spaceOrInstance.parentSpace, callback);
              }.bind(this)).get(spaceOrInstance.parentURI);
            }
          }
        } else {
          callback.call(this, spaceOrInstance);
        }
      },

      /**
       * Gets the URI to get json data of space represented by the given parameter.
       * @param space a space object or a spaceId
       * @returns {string} an URI.
       */
      getSpaceUri : function(space) {
        return "spaces/" + this._getObjectId(space);
      },

      /**
       * Gets the URI to get all the direct spaces of a space represented by the given parameter.
       * @param space a space object or a spaceId
       * @returns {string} an URI.
       */
      getSpaceContentUri : function(space) {
        return "spaces/" + this._getObjectId(space) + "/content";
      },

      /**
       * Indicates if the given content json object represents a space.
       * @param object a json object.
       * @returns {boolean} true if it represents a space, false otherwise.
       */
      isObjectTypeOfSpace : function(object) {
        return object !== null && (typeof object === 'object') && object.type === 'space';
      },

      /**
       * Gets the page URL of space represented by the given parameter.
       * This method handles the special case of home page. If the identifier of the space is
       * equals to '-1', then the homepage page URL is returned.
       * @param space a space object or a spaceId
       * @returns {string} a page URL.
       */
      getSpacePageUrl : function(space) {
        var spaceId = this._getObjectId(space);
        if (spaceId === '-1') {
          return '/';
        }
        return "/spaces/" + this._getObjectId(space);
      },

      /**
       * Indicates if the given object represents a valid identifier of space.
       */
      isValidSpaceId : function(spaceId) {
        return (typeof  spaceId === 'string') && spaceId.length > 0 && spaceId !== '-1';
      },

      /**
       * Indicates if the given object represents a valid space object.
       */
      isValidSpace : function(object) {
        return this.isObjectTypeOfSpace(object) && this.isValidSpaceId(object.id);
      },

      /**
       * Gets the id attribute of the given parameter.
       * @param object an object or a string.
       * @returns {*} the string identifier.
       * @private
       */
      _getObjectId : function(object) {
        var objectId = object;
        if (typeof object === 'object' && object !== null) {
          objectId = object.id;
          if (object.type === 'component') {
            objectId = object.name + objectId;
          }
        }
        return objectId;
      }
    };
  })();
</script>