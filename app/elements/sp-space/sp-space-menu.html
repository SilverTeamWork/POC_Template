<dom-module id="sp-space-menu">
  <template>
    <iron-localstorage id="spaceMenuContextLS"
                       name="sp-space-menu-context"
                       value="{{spaceMenuContext}}"></iron-localstorage>
    <aside class$="[[spaceMenuContext.classes]]" id="nav-gauche">
      <a class="icon-menu" href="#" title="Cacher ce menu que je ne saurais voir"
         on-click="menuToggle">Menu</a>
      <nav>
        <sp-space-menu-content space="[[space]]"></sp-space-menu-content>
      </nav>
    </aside>
  </template>
</dom-module>
<script>
  (function() {

    var NAV_GAUCHE = 'aside-gauche';

    var __allInstances = [];

    Polymer({
      is : 'sp-space-menu',

      behaviors : [SpaceBehavior],

      properties : {

        context : {
          type : Object
        },

        /**
         * The context permits to handles several menus that must display same content.
         * It avoids to get some bad flickering...
         */
        spaceMenuContext : {
          type : Object
        }
      },

      observers : ['_spaceChanged(context.space.model)', '_instanceChanged(context.instance.model)',
        '_renderDeployment(spaceMenuContext.deployed)'],

      ready : function() {
        this._renderDeployment();
      },

      attached : function() {
        __allInstances.push(this);
      },

      detached : function() {
        __allInstances.remove(this);
      },

      menuToggle : function(e) {
        e.preventDefault();
        e.stopPropagation();
        __allInstances.forEach(function($this) {
          $this.set('spaceMenuContext.deployed', !$this.spaceMenuContext.deployed);
        });
      },

      _spaceChanged : function() {
        if (this.context.space.model) {
          this.space = this.context.space.model;
        }
      },

      _instanceChanged : function() {
        if (this.context.instance.model) {
          this._loadParentSpaces(this.context.instance.model, function() {
            this.space = this.context.instance.model.parentSpace;
          }.bind(this));
        }
      },

      _renderDeployment : function() {
        if (this.spaceMenuContext) {
          var classes = NAV_GAUCHE +
              ((this.spaceMenuContext && !this.spaceMenuContext.deployed) ? ' minimize' : '');
          this.set('spaceMenuContext.classes', classes);
        } else {
          this.spaceMenuContext = {
            deployed: true,
            classes: NAV_GAUCHE
          };
        }
      }
    });
  })();
</script>
