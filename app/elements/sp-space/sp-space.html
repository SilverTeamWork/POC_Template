<link rel="import" href="../sp-breadcrumb/sp-breadcrumb.html">

<dom-module id="sp-space">
  <template>
    <sp-notifier id="msgNotFound" type="error">
      Il n'existe pas d'espace ayant l'identifiant <b><span>{{msgSpaceId}}</span></b>.
    </sp-notifier>

    <sp-service-ajax id="requester"
                     path="[[getSpaceUri(context.spaceId)]]"
                     last-response="{{currentSpace}}"
                     on-error="_spaceNotFound"></sp-service-ajax>
    <div class="main-container flexitem-fluid flexbox-h">
      <sp-space-menu class="flexbox-v" space="[[currentSpace]]"></sp-space-menu>
      <div class="main wrapper flexitem-fluid">
        <sp-breadcrumb></sp-breadcrumb>
        <section class="space">
          <template is="dom-if" if="[[isSpaceFound]]">
            <h2 class="title"><span>Chez Silverpeas</span></h2>
            Space label: <span id="spaceId">{{currentSpace.label}}</span><br/>
            Space description: <span>{{currentSpace.description}}</span>
          </template>
        </section>
      </div>
    </div>
  </template>
</dom-module>
<script>
  (function() {

    Polymer({
      is : 'sp-space',

      behaviors : [SpaceBehavior],

      properties : {

        context : {
          type : Object
        },

        currentSpace : {
          type : Object, notify : true, observer : '_currentSpaceChanged'
        },

        isSpaceFound : {
          type : Boolean, notify : true, readOnly : true
        }
      },

      observers: ['_spaceIdChanged(context.spaceId)'],

      ready : function() {
        document.body.addEventListener('last-accessed-application-instance', function(e) {
          // When a application instance homepage is accessed, this page must be cleared in order to get a right behavior!
          //this.context.spaceId = null;
        }.bind(this));
      },

      _spaceIdChanged : function() {
        this.$.msgNotFound.hide();
        if (this.isValidSpaceId(this.context.spaceId)) {
          console.log('space reload');
          this.$.requester.send();
        }
      },

      _spaceNotFound : function() {
        this.currentSpace = null;
        this.msgSpaceId = this.context.spaceId;
        this.$.msgNotFound.show();
        this._currentSpaceChanged();
      },

      _currentSpaceChanged : function() {
        this._setIsSpaceFound(this.isValidSpace(this.currentSpace));
        this._loadParentSpaces(this.currentSpace, function() {
          this.fire('last-accessed-space', this.currentSpace);
        });
      }
    });
  })();
</script>
