<script>
  (function() {
    'use strict';

    Polymer({
      is : 'sp-service-ajax',

      behaviors : [SessionBehavior, SilverpeasUrl],

      properties : {
        path : {
          type : String, value : ''
        },

        /**
         * An object that contains query parameters to be appended to the
         * specified `url` when generating a request. If you wish to set the body
         * content when making a POST request, you should use the `body` property
         * instead.
         */
        params : {
          type : Object, value : function() {
            return {};
          }
        },

        /**
         * The HTTP method to use such as 'GET', 'POST', 'PUT', or 'DELETE'.
         * Default is 'GET'.
         */
        method : {
          type : String, value : 'GET'
        },

        /**
         * HTTP request headers to send.
         *
         * Example:
         *
         *     <iron-ajax
         *         auto
         *         url="http://somesite.com"
         *         headers='{"X-Requested-With": "XMLHttpRequest"}'
         *         handle-as="json"
         *         last-response-changed="{{handleResponse}}"></iron-ajax>
         *
         * Note: setting a `Content-Type` header here will override the value
         * specified by the `contentType` property of this element.
         */
        headers : {
          type : Object, value : function() {
            return {};
          }
        },

        /**
         * Content type to use when sending data. If the `contentType` property
         * is set and a `Content-Type` header is specified in the `headers`
         * property, the `headers` property value will take precedence.
         */
        contentType : {
          type : String, value : 'application/x-www-form-urlencoded'
        },

        /**
         * Optional raw body content to send when method === "POST".
         *
         * Example:
         *
         *     <iron-ajax method="POST" auto url="http://somesite.com"
         *         body='{"foo":1, "bar":2}'>
         *     </iron-ajax>
         */
        body : {
          type : String, value : ''
        },

        /**
         * If true, automatically performs an Ajax request when either `url` or
         * `params` changes.
         */
        auto : {
          type : Boolean, value : false
        },

        /**
         * Will be set to the most recent response received by a request
         * that originated from this iron-ajax element. The type of the response
         * is determined by the value of `handleAs` at the time that the request
         * was generated.
         */
        lastResponse : {
          type : Object, notify : true, readOnly : true
        },

        /**
         * Will be set to the most recent error that resulted from a request
         * that originated from this iron-ajax element.
         */
        lastError : {
          type : Object, notify : true, readOnly : true
        }
      },

      observers : ['_requestOptionsChanged(path, method, params, auto)'],

      created : function() {
        this.silverpeasServiceBaseUrl = this.silverpeasUrl + '/services/';
      },

      send : function() {
        if (typeof this.path !== 'string' || this.path.length == 0) {
          return;
        }
        var self = this;
        var ajax = document.createElement("iron-ajax");

        // Wiring all parameters
        ajax.params = this.params;
        ajax.method = this.method;
        ajax.headers = this.headers;
        ajax.contentType = this.contentType;
        ajax.body = this.body;

        // Settings the session
        var sessionId = this._getSessionId();
        if (typeof sessionId === 'string' && sessionId.length > 0) {
          ajax.headers["X-Silverpeas-Session"] = sessionId;
        }

        // Wiring events
        ajax.addEventListener('response', function(e) {
          self._setLastResponse(ajax.lastResponse);
          self.fire('response', e.detail)
        });
        ajax.addEventListener('error', function(e) {
          self._setLastError(ajax.lastError);
          self.fire('error', e.detail)
        });

        // URL
        var normalizedUrl = this.path;
        if (this.path.indexOf("http") < 0) {
          normalizedUrl = this.silverpeasServiceBaseUrl + normalizedUrl;
          normalizedUrl = normalizedUrl.replace(/[^:]\/{2,}/gi, '/')
        }
        ajax.url = normalizedUrl;

        ajax.debounceDuration = 300;
        return ajax.generateRequest();
      },

      _getSessionId : function() {
        return this.sessionKey;
      },

      _requestOptionsChanged : function() {
        if (this.auto) {
          this.send();
        }
      }
    });
  })();
</script>
