<script>
  (function() {
    'use strict';

    Polymer({
      is : 'sp-service-ajax',

      behaviors : [SessionBehavior],

      properties : {
        path : {
          type : String, value : ''
        }, method : {
          type : String, value : 'GET'
        }, params : {
          type : Object, value : function() {
            return {};
          }
        },

        /**
         * If true, automatically performs an Ajax request when either `url` or
         * `params` changes.
         */
        auto : {
          type : Boolean, value : false
        },

        /**
         * Will be set to the most recent response received by a request
         * that originated from this iron-ajax element. The type of the response
         * is determined by the value of `handleAs` at the time that the request
         * was generated.
         */
        lastResponse : {
          type : Object, notify : true, readOnly : true
        },

        /**
         * Will be set to the most recent error that resulted from a request
         * that originated from this iron-ajax element.
         */
        lastError : {
          type : Object, notify : true, readOnly : true
        }
      },

      observers : ['_requestOptionsChanged(path, method, params, auto)'],

      created : function() {
        this.silverpeasServiceBaseUrl = 'http://localhost:8000/silverpeas/services/'
      },

      send : function() {
        if (typeof this.path !== 'string' || this.path.length == 0) {
          return;
        }
        var self = this;
        var ajax = document.createElement("iron-ajax");
        ajax.url = ((this.path.indexOf("http") < 0 ? this.silverpeasServiceBaseUrl : '') +
        this.path).replace(/[^:]\/{2,}/gi, '/');
        ajax.params = (typeof this.params === 'object' ? this.params : {});

        var sessionId = this._getSessionId();
        if (typeof sessionId === 'string' && sessionId.length > 0) {
          ajax.headers = {"X-Silverpeas-Session" : sessionId};
        }

        ajax.addEventListener('response', function(e) {
          self._setLastResponse(ajax.lastResponse);
          self.fire('response', e.detail)
        });

        ajax.addEventListener('error', function(e) {
          self._setLastError(ajax.lastError);
          self.fire('error', e.detail)
        });

        return ajax.generateRequest();
      },

      _getSessionId : function() {
        return this.sessionKey;
      },

      _requestOptionsChanged : function() {
        if (this.auto) {
          this.send();
        }
      }
    });
  })();
</script>
