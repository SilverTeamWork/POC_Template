<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../sp-session/sp-session.html">
<link rel="import" href="../sp-ajax/sp-service-ajax-behavior.html"/>

<script>
  (function() {
    'use strict';

    Polymer({
      is : 'sp-service-ajax',

      behaviors : [SessionBehavior, SilverpeasServiceAjaxBehavior],

      properties : {
        path : {
          type : String, value : ''
        },

        /**
         * An object that contains query parameters to be appended to the
         * specified `url` when generating a request. If you wish to set the body
         * content when making a POST request, you should use the `body` property
         * instead.
         */
        params : {
          type : Object, value : function() {
            return {};
          }
        },

        /**
         * The HTTP method to use such as 'GET', 'POST', 'PUT', or 'DELETE'.
         * Default is 'GET'.
         */
        method : {
          type : String, value : 'GET'
        },

        /**
         * HTTP request headers to send.
         *
         * Example:
         *
         *     <iron-ajax
         *         auto
         *         url="http://somesite.com"
         *         headers='{"X-Requested-With": "XMLHttpRequest"}'
         *         handle-as="json"
         *         last-response-changed="{{handleResponse}}"></iron-ajax>
         *
         * Note: setting a `Content-Type` header here will override the value
         * specified by the `contentType` property of this element.
         */
        headers : {
          type : Object, value : function() {
            return {};
          }
        },

        /**
         * Content type to use when sending data. If the `contentType` property
         * is set and a `Content-Type` header is specified in the `headers`
         * property, the `headers` property value will take precedence.
         */
        contentType : {
          type : String, value : 'application/x-www-form-urlencoded'
        },

        /**
         * Optional raw body content to send when method === "POST".
         *
         * Example:
         *
         *     <iron-ajax method="POST" auto url="http://somesite.com"
         *         body='{"foo":1, "bar":2}'>
         *     </iron-ajax>
         */
        body : {
          type : String, value : ''
        },

        /**
         * If true, automatically performs an Ajax request when either `url` or
         * `params` changes.
         */
        auto : {
          type : Boolean, value : false
        },

        /**
         * Will be set to the most recent response received by a request
         * that originated from this iron-ajax element. The type of the response
         * is determined by the value of `handleAs` at the time that the request
         * was generated.
         */
        lastResponse : {
          type : Object, notify : true, readOnly : true
        },

        /**
         * Will be set to the most recent error that resulted from a request
         * that originated from this iron-ajax element.
         */
        lastError : {
          type : Object, notify : true, readOnly : true
        }
      },

      observers : ['_requestOptionsChanged(path, method, params, auto)'],

      send : function() {
        if (typeof this.path !== 'string' || this.path.length == 0) {
          return;
        }
        var self = this;

        var ajax = this.newSilverpeasServiceAjax();

        // Wiring all parameters
        ajax.withParams(this.params).withHeaders(this.headers);
        ajax.withBody(this.body).ofContentType(this.contentType);

        // Wiring events
        ajax.onResponse(function(e) {
          self._setLastResponse(e.detail.response);
          self.fire('response', e.detail)
        });
        ajax.onError(function(e) {
          self._setLastError(e.detail.error);
          self.fire('error', e.detail)
        });

        return ajax.send(this.path, this.method);
      },

      _requestOptionsChanged : function() {
        if (this.auto) {
          this.send();
        }
      }
    });
  })();
</script>
