<dom-module id="sp-post-content">
  <template>
    <div class="content-from-wysiwyg"></div>
  </template>

  <script>
    Polymer({
      is : 'sp-post-content', properties : {
        post : {
          type : Object, observer : '_onPostChange'
        }
      },
      _onPostChange : function() {
        this.$$('.content-from-wysiwyg').innerHTML = this.post.content;
      }
    });
  </script>
</dom-module>

<dom-module id="sp-post-view">
  <template>
    <sp-app-instance-header title="[[post.title]]">
      <template is="dom-if" if="{{hasModificationRightsOn(post)}}">
        <sp-app-instance-menu>
          <li><a href$="[[editionUrl]]">Modifier ce billet</a></li>
        </sp-app-instance-menu>
      </template>
      <p class="post-info">
        <sp-rating id="postRatingId" appid="[[post.componentId]]" contributionid="[[post.id]]"></sp-rating>
        <a href="#commentaires" class="nb-comment"><img src="../../images/talk2user.gif" alt="commentaire"/>&nbsp;<span id="nbComment">[[post.nbComments]]</span></a>
      </p>
    </sp-app-instance-header>

    <sp-app-instance-right-panel>
      <sp-date-picker id="datePicker"></sp-date-picker>
    </sp-app-instance-right-panel>

    <sp-post-content post="[[post]]"></sp-post-content>

    <sp-comments id="spCommentId" appid="[[post.componentId]]" contributionid="[[post.id]]"
                 authorid="[[_userId()]]" avatarurl="[[_userAvatarUrl()]]" canbeupdated="true"></sp-comments>
    <footer>
      <p class="publication-detail"> <span class="publication">Publiée le <time datetime$="[[publicationDate.toIso8601]]">[[publicationDate.toLocaleDateTime]]</time>
        <span class="auteur">par <span>[[post.creator]]</span></span></span>
        <span class="sep"> - </span> <span class="modification">Modifié le <time datetime$="[[modificationDate.toIso8601]]">[[modificationDate.toLocaleDateTime]]</time>
        <span class="auteur">par <span>[[post.updater]]</span></span></span></p>
    </footer>
  </template>

  <script>
    Polymer({
      is : 'sp-post-view',
      behaviors : [DateBehavior, SessionBehavior, SilverpeasUrl, AccessControlBehavior],
      properties : {
        post : {
          type : Object, observer : '_onPostChange'
        }
      },
      listeners : {
        'comment-removed' : '_commentRemoved', 'comment-created' : '_commentCreated'
      },
      _onPostChange : function() {
        console.log("view post " + this.post.id + ": " + this.post.title);
        this.creationDate = this._date(this.post.createDate);
        this.publicationDate = this._date(this.post.dateEvent);
        this.modificationDate = this._date(this.post.updateDate);
        this.$.datePicker.event = new Date(this.post.dateEvent);
        this.editionUrl =
            '/instances/' + this.post.componentId + '/posts/' + this.post.id + '?state=edition';
        document.querySelector('#postRatingId')._retrieveContributionRating();
        document.querySelector('#spCommentId').setAttribute("appid", this.post.componentId);
        document.querySelector('#spCommentId').setAttribute("contributionid", this.post.id);
        document.querySelector('#spCommentId').setAttribute("authorid", this.currentUser.id);
        console.log("sp-post-view : authorId = " + this.currentUser.id);
        document.querySelector('#spCommentId').setAttribute("avatarurl", this._userAvatarUrl());
        document.querySelector('#spCommentId').loadComments();
      },
      _userAvatarUrl : function() {
        console.log("sp-post-view avatar=" + this.currentUser.avatar);
        return this.silverpeasHost + this.currentUser.avatar;
      },
      _userId : function() {
        console.log("sp-post-view userid=" + this.currentUser.id);
        return this.currentUser.id;
      },
      _commentRemoved : function() {
        console.log("sp-post-view decrement nbComment");
        this.post.nbComments = --this.post.nbComments;
        this.$.nbComment.textContent = this.post.nbComments;
      },
      _commentCreated : function() {
        console.log("sp-post-view increment nbComment");
        this.post.nbComments = ++this.post.nbComments;
        this.$.nbComment.textContent = this.post.nbComments;
      }
    });
  </script>
</dom-module>