<dom-module id="sp-post-snippet">
  <template>
    <div class="content-from-wysiwyg"></div>
  </template>
</dom-module>

<dom-module id="sp-post-item">
  <link href="http://code.jquery.com/ui/1.11.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet" type="text/css"/>
  <style>
    .paper-dialog-div {
      position: absolute;
    }
    #confirm {
      position: relative;
      height: auto;
      left: 50%;
      width: 300px;
    }
  </style>
  <template>
    <div class="paper-dialog-div">
      <paper-dialog id="confirm" modal="true"
                    entry-animation="scale-up-animation" exit-animation="fade-out-animation"
                    class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-front ui-dialog-buttons ui-draggable ui-resizable">
        <h2>Confirmation</h2>
        <div class="ui-dialog-content ui-widget-content">
          <p>Êtes vous sûr de vouloir le supprimer ?</p>
        </div>
        <div id="button-bar" class="ui-dialog-buttonpane ui-widget-content ui-helper-clearfix">
          <div id="button-set" class="ui-dialog-buttonset">
            <paper-button label="Annuler" dialog-dismiss autofocus class="button btn">
              <span class="ui-button-text">Annuler</span></paper-button>
            <paper-button label="Ok" dialog-confirm on-click="_onConfirm" class="button btn">
              <span class="ui-button-text">Ok</span></paper-button>
          </div>
        </div>
      </paper-dialog>
      <sp-service-ajax id="deletion"
                       method="DELETE"
                       on-response="_handleResponse">
      </sp-service-ajax>
    </div>
    <article>
      <div on-click="_selectPost">
      <header>
        <time class="calendar-presentation" datetime$="[[creationDate.toIso8601]]">
          <span class="day">[[creationDate.day]]</span> <span class="number">[[creationDate.dayOfMonth]]</span>
          <span class="month">[[creationDate.month]]</span> <span class="year">[[creationDate.year]]</span>
        </time>
        <h3><a class="link-article" href="#" on-click="_selectPost"><span class="editable input text">[[post.title]]</span></a>
        </h3>

        <p class="post-info">
          <sp-rating appid="[[post.componentId]]" contributionid="[[post.id]]" readonly></sp-rating>
          <a href="billet.html#commentaires" class="nb-comment"><img src="../../images/talk2user.gif" alt="commentaire"/> <span>[[post.nbComments]]</span></a>
        </p>
      </header>
      <sp-post-snippet post="[[post]]"></sp-post-snippet>
      </div>
      <footer>
        <p class="publication-detail" on-click="_selectPost">
          <span class="publication">Publié le <time datetime$="[[publicationDate.toIso8601]]">[[publicationDate.toLocaleDateTime]]</time> <span class="auteur">par <span>[[post.creator]]</span></span></span>
          <span class="sep"> - </span>
          <span class="modification">Modifié le <time datetime$="[[modificationDate.toIso8601]]">[[modificationDate.toLocaleDateTime]]</time> <span class="auteur">par <span>[[post.updater]]</span></span></span>
        </p>
        <div class="operation">
          <a title="Modifier" href$="[[editionUrl]]"><img title="Modifier" alt="Modifier" src="../../images/update.gif"/></a>
          <button-paper id="postDeletion" label="Supprimer" on-click="_toggleConfirm">
            <img title="Supprimer" alt="Supprimer" src="../../images/delete.gif"/>
          </button-paper>
        </div>
      </footer>
    </article>
  </template>
</dom-module>

<dom-module id="sp-post-list">
  <template>
    <sp-service-ajax
        id="postsFetcher"
        on-response="_handleResponse">
    </sp-service-ajax>
    <div id="blog-posts-list">
    <template is="dom-repeat" items="[[posts]]" as="post">
      <sp-post-item post="[[post]]"></sp-post-item>
    </template>
    </div>
  </template>
</dom-module>

<script>
  'use strict';

  (function() {
    // the snippet of a given post
    Polymer({
      is: 'sp-post-snippet',
      properties: {
        post: {
          type: Object
        }
      },
      ready: function() {
        this.$$('.content-from-wysiwyg').innerHTML = this._snippet(this.post);
      },
      _snippet : function(post) {
        var snippet = post.content;
        var idx = snippet.length;
        for (var i = snippet.indexOf(". ", 0), p = 0; p < 10 && i != -1; i =
            snippet.indexOf(". ", idx)) {
          idx = i + 1;
        }
        snippet = snippet.substring(0, idx);
        return snippet + '<br/><br/>';
      }
    });

    // a brief presentation of a given post within a list
    Polymer({
      is : 'sp-post-item',
      behaviors : [DateBehavior],
      properties : {
        post : {
          type : Object
        }
      },
      ready: function() {
        this.creationDate = this._date(this.post.createDate);
        this.publicationDate = this._date(this.post.dateEvent);
        this.modificationDate = this._date(this.post.updateDate);
        this.$.deletion.path = 'blogs/' + this.post.componentId + '/posts/' + this.post.id;
        this.editionUrl = '/instances/' + this.post.componentId + '/posts/' + this.post.id + '?state=edition';
      },
      _selectPost : function(event) {
        event.preventDefault();
        event.stopPropagation();
        this.fire('post-selected', {post: this.post})
      },
      _toggleConfirm: function() {
        event.stopImmediatePropagation();
        this.$.confirm.toggle();
      },
      _onConfirm: function() {
        this.$.deletion.send();
      },
      _handleResponse: function(event) {
        if (event.detail.succeeded) {
          this.remove();
        }
      }
    });

    // a list of posts of a given post
    // by default, the list of posts is reloaded only if the blog change. To force to reload the
    // list, then use the reload() function.
    Polymer({
      is : 'sp-post-list',
      properties : {
        blog: {
          type: String,
          observer: '_onBlogChange'
        },
        posts : {
          type : Array,
          value: [],
          notify : true,
          readOnly : true
        }
      },
      listeners: {
        'blog-posts-list.mouseover':'_addListenerOnScrolling',
        'blog-posts-list.mouseout': '_removeListenerOnScrolling'
      },
      ready: function() {
        console.log("List posts of blog " + this.blog);
        this._scrollHandler = this._onScroll.bind(this);
      },
      reload: function() {
        this._onBlogChange();
      },
      _onBlogChange: function() {
        this._setPosts([]);
        this._fullLoaded = false;
        this._page = 5;
        if (!this.blog) {return;}
        console.log('query posts of blog ' + this.blog);
        this.$.postsFetcher.path = 'blogs/' + this.blog + '/posts?page=1;5';
        this.$.postsFetcher.send();
      },
      _handleResponse : function(event) {
        var newPosts = event.detail.response.entities;
        if (newPosts.length > 0)
          this._setPosts(this.posts.concat(event.detail.response.entities));
        else
          this._fullLoaded = true;
      },
      _addListenerOnScrolling: function() {
        window.addEventListener('scroll', this._scrollHandler);
      },
      _removeListenerOnScrolling: function() {
        window.removeEventListener('scroll', this._scrollHandler);
      },
      _onScroll: function() {
        var scrollMaxY = (window.scrollMaxY ? window.scrollMaxY :
          document.documentElement.scrollHeight - document.documentElement.clientHeight + 1);
        if ((scrollMaxY - window.scrollY) <= 100 && !this._fullLoaded) {
          console.log("I'm fetching additional posts dude! ");
          this._page += 1;
          this.$.postsFetcher.path = 'blogs/' + this.blog + '/posts?page=' + this._page + ';1';
          this.$.postsFetcher.send();
        }
      }
    });

  })();
</script>