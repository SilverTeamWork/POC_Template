<dom-module id="sp-post-snippet">
  <template>
    <div class="content-from-wysiwyg"></div>
  </template>

  <script>
    // the snippet of a given post
    Polymer({
      is: 'sp-post-snippet',
      properties: {
        post: {
          type: Object
        }
      },
      ready: function() {
        this.$$('.content-from-wysiwyg').innerHTML = this._snippet(this.post);
      },
      _snippet : function(post) {
        var snippet = post.content;
        var idx = snippet.length;
        for (var i = snippet.indexOf(". ", 0), p = 0; p < 10 && i != -1; i =
            snippet.indexOf(". ", idx)) {
          idx = i + 1;
        }
        snippet = snippet.substring(0, idx);
        return snippet + '<br/><br/>';
      }
    });
  </script>
</dom-module>

<dom-module id="sp-post-item">
  <link href="http://code.jquery.com/ui/1.11.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet" type="text/css"/>
  <style>
    .paper-dialog-div {
      position: absolute;
    }
    #confirm {
      position: relative;
      height: auto;
      left: 50%;
      width: 300px;
    }

    .title-operation {
      float:right;
      padding: 5px 10px 10px 10px;
      display: none;
    }

    .link-article:hover .title-operation,
    .link-article:focus .title-operation,
    .link-article:active .title-operation{
      display: block;
    }
  </style>
  <template>
    <div class="paper-dialog-div">
      <paper-dialog id="confirm" modal="true"
                    entry-animation="scale-up-animation" exit-animation="fade-out-animation"
                    class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-front ui-dialog-buttons ui-draggable ui-resizable">
        <h2>Confirmation</h2>
        <div class="ui-dialog-content ui-widget-content">
          <p>Êtes vous sûr de vouloir le supprimer ?</p>
        </div>
        <div id="button-bar" class="ui-dialog-buttonpane ui-widget-content ui-helper-clearfix">
          <div id="button-set" class="ui-dialog-buttonset">
            <paper-button label="Annuler" dialog-dismiss autofocus class="button btn">
              <span class="ui-button-text">Annuler</span></paper-button>
            <paper-button label="Ok" dialog-confirm on-click="_onConfirm" class="button btn">
              <span class="ui-button-text">Ok</span></paper-button>
          </div>
        </div>
      </paper-dialog>
      <sp-notifier id="updateSuccess" type="success">
        Le titre du billet a bien été mis à jour.
      </sp-notifier>
      <sp-notifier id="updateError" type="error">
        Une erreur est survenue. Votre billet n'a pas pu être mis à jour.
      </sp-notifier>
      <sp-notifier id="titleError" type="error">
        Le titre ne peut être vide.
      </sp-notifier>
      <sp-service-ajax
          id="update"
          path="[[postUrl]]"
          method="PUT"
          content-type="application/json"
          handle-as="json"
          body="[[post]]"
          on-response="_success"
          on-error="_error">
      </sp-service-ajax>
      <sp-service-ajax id="deletion"
                       method="DELETE"
                       on-response="_handleResponse">
      </sp-service-ajax>
    </div>
    <article on-click="_selectPost">
      <header>
        <time class="calendar-presentation" datetime$="[[publicationDate.toIso8601]]">
          <span class="day">[[publicationDate.day]]</span> <span class="number">[[publicationDate.dayOfMonth]]</span>
          <span class="month">[[publicationDate.month]]</span>
          <span class="year">[[publicationDate.year]]</span>
        </time>
        <h3>
          <template is="dom-if" if="{{!_updateTitle}}">
            <template is="dom-if" if="{{hasModificationRightsOn(post)}}">
              <button class="link-article" on-click="_updatePostTitle"><span class="input text">[[post.title]]</span>
                <img class="title-operation" title="Modifier" alt="Modifier" src="../../images/update.gif"/></button>
            </template>
            <template is="dom-if" if="{{!hasModificationRightsOn(post)}}">
              <button class="link-article"><span class="input text">[[post.title]]</span></button>
            </template>
          </template>
          <template is="dom-if" if="{{_updateTitle}}">
            <iron-a11y-keys target="{{_updateTitleInput()}}" keys="esc enter" on-keys-pressed="_doUpdatePostTitle"></iron-a11y-keys>
            <input id="updateTitle" class="input text" style="width: 80%" value="{{_title::input}}" on-mouseover="_focus" on-click="_updatePostTitle">
          </template>
        </h3>

        <p class="post-info">
          <sp-rating appid="[[post.componentId]]" contributionid="[[post.id]]" readonly></sp-rating>
          <a href="billet.html#commentaires" class="nb-comment"><img src="../../images/talk2user.gif" alt="commentaire"/>
            <span>[[post.nbComments]]</span></a>
        </p>
      </header>
      <sp-post-snippet post="[[post]]"></sp-post-snippet>
      <footer>
        <p class="publication-detail">
          <span class="publication">Publié le <time datetime$="[[publicationDate.toIso8601]]">[[publicationDate.toLocaleDateTime]]</time> <span class="auteur">par <span>[[post.creator]]</span></span></span>
          <span class="sep"> - </span>
          <span class="modification">Modifié le <time datetime$="[[modificationDate.toIso8601]]">[[modificationDate.toLocaleDateTime]]</time> <span class="auteur">par <span>[[post.updater]]</span></span></span>
        </p>
        <template is="dom-if" if="{{hasModificationRightsOn(post)}}">
          <div class="operation">
            <a title="Modifier" href$="[[editionUrl]]"><img title="Modifier" alt="Modifier" src="../../images/update.gif"/></a>
            <button-paper id="postDeletion" label="Supprimer" on-click="_toggleConfirm">
              <img title="Supprimer" alt="Supprimer" src="../../images/delete.gif"/>
            </button-paper>
          </div>
        </template>
      </footer>
    </article>
  </template>
  <script>
    // a brief presentation of a given post within a list
    Polymer({
      is : 'sp-post-item',
      behaviors : [DateBehavior, AccessControlBehavior],
      properties : {
        post : {
          type : Object,
          observer: '_onPostChange'
        },
        postUrl: {
          type: String,
          computed: '_computePostUrl(post)'
        }
      },
      _onPostChange: function() {
        this.creationDate = this._date(this.post.createDate);
        this.publicationDate = this._date(this.post.dateEvent);
        this.modificationDate = this._date(this.post.updateDate);
        this.$.deletion.path = 'blogs/' + this.post.componentId + '/posts/' + this.post.id;
        this.editionUrl = '/instances/' + this.post.componentId + '/posts/' + this.post.id + '?state=edition';
        this._updateTitle = false;
      },
      _selectPost : function(event) {
        this.fire('post-selected', {post: this.post});
      },
      _toggleConfirm: function() {
        event.stopImmediatePropagation();
        this.$.confirm.toggle();
      },
      _onConfirm: function() {
        this.$.deletion.send();
      },
      _handleResponse: function(event) {
        if (event.detail.succeeded) {
          this.remove();
        }
      },
      _titleUpdateIconShow: function() {
        console.log("coucou");
        this.$.titleUpdateIcon.show();
      },
      _titleUpdateIconHide: function() {
        this.$.titleUpdateIcon.hide();
      },
      _updatePostTitle: function(event) {
        event.preventDefault();
        event.stopPropagation();
        if (!this._updateTitle) {
          this._title = this.post.title;
          this._updateTitle = true;
        }
      },
      _focus: function() {
        this._updateTitleInput().focus();
      },
      _doUpdatePostTitle: function(event) {
        if (event.detail.keyboardEvent.keyCode === 13) {
          if (this._title && this._title.trim().length > 0) {
            this.post.title = this._title;
            this.$.update.send();
          } else {
            this.$.titleError.show();
          }
        }
        this._updateTitle = false;
      },
      _updateTitleInput: function() {
        return this.$$('#updateTitle');
      },
      _computePostUrl: function(post) {
        return 'blogs/' + post.componentId + '/posts/' + (this.post.id === null ? '':this.post.id);
      },
      _success: function() {
        this.notifyPath('post.title', this._title);
        this.$.updateSuccess.show();
      },
      _error: function() {
        this.$.updateError.show();
      }
    });
  </script>

</dom-module>

<dom-module id="sp-post-list">
  <template>
    <sp-service-ajax
        id="postsFetcher"
        on-response="_handleResponse">
    </sp-service-ajax>
    <sp-notifier id="error" type="error">
      Une erreur est survenue lors de la récupération des billets pour le calendrier.
    </sp-notifier>
    <header>
      <h2 class="title"><span id="title">{{blog.label}}</span></h2>
      <aside id="applicationMenu" class="menu actions">
        <div><a class="button select" href="#">Plus</a>
          <ul>
            <template is="dom-if" if="{{hasCreationRightOn(_postList)}}">
              <li><a href$="[[postCreationUrl]]">Créer un billet</a></li>
            </template>
            <li><a href="#">S'abonner</a></li>
            <li><a href="#">Responsable de l'application</a></li>
          </ul>
        </div>
      </aside>
      <p id="description">{{blog.description}}</p>
    </header>
    <aside class="aside-app" id="aside-app-fixed">
      <sp-date-picker events="[[_events]]"
                   on-date-selected="_renderPostsAtGivenDate"
                   on-date-unselected="_renderPreviousAllPosts">
      </sp-date-picker>
    </aside>
    <div id="blog-posts-list">
    <template is="dom-repeat" items="{{posts}}" as="post">
      <sp-post-item post="[[post]]"></sp-post-item>
    </template>
    </div>
  </template>

  <script>
    // a list of posts of a given post
    // by default, the list of posts is reloaded only if the blog change. To force to reload the
    // list, then use the reload() function.
    Polymer({
      is : 'sp-post-list',
      behaviors: [AccessControlBehavior, SilverpeasServiceAjaxBehavior],
      properties : {
        blog: {
          type: Object,
          observer: '_onBlogChange'
        },
        posts : {
          type : Array,
          value: [],
          notify : true,
          readOnly : true
        },
        _postList: {
          type: Object
        }
      },
      listeners: {
        'blog-posts-list.mouseover':'_addListenerOnScrolling',
        'blog-posts-list.mouseout': '_removeListenerOnScrolling'
      },
      ready: function() {
        this._scrollHandler = this._onScroll.bind(this);
        this._dateSelected = false;
      },
      reload: function() {
        this._onBlogChange();
      },
      _loadAllEvents: function() {
        SilverpeasServiceAjaxBehavior.newSilverpeasServiceAjax().onResponse(function(e) {
          this._allPosts = e.detail.response.entities;
          var events = [];
          for (var i = 0; i < e.detail.response.entities.length; i++) {
            events.push(new Date(e.detail.response.entities[i].dateEvent));
          }
          this._events = events;
        }.bind(this)).onError(function(e) {
            console.log(error);
            this.$.error.show();
        }.bind(this)).get('blogs/' + this.blog.instanceId + '/posts');
      },
      _onBlogChange: function() {
        this._dateSelected = false;
        this._setPosts([]);
        this._fullLoaded = false;
        this._page = 5;
        if (!this.blog) {return;}
        console.log("List posts of blog " + this.blog.label);
        this.blog.instanceId = this.blog.name + this.blog.id;
        this.postCreationUrl = '/instances/' + this.blog.instanceId + '/posts/new';
        this.$.postsFetcher.path = 'blogs/' + this.blog.instanceId + '/posts?page=1;5';
        this.$.postsFetcher.send();
        this._loadAllEvents();
      },
      _handleResponse : function(event) {
        this._postList = event.detail.response;
        if (this._postList.entities.length > 0) {
          this._setPosts(this.posts.concat(this._postList.entities));
        } else {
          this._fullLoaded = true;
        }
      },
      _addListenerOnScrolling: function() {
        window.addEventListener('scroll', this._scrollHandler);
      },
      _removeListenerOnScrolling: function() {
        window.removeEventListener('scroll', this._scrollHandler);
      },
      _onScroll: function() {
        var scrollMaxY = (window.scrollMaxY ? window.scrollMaxY :
          document.documentElement.scrollHeight - document.documentElement.clientHeight + 1);
        if ((scrollMaxY - window.scrollY) <= 100 && !this._fullLoaded && !this._dateSelected) {
          console.log("I'm fetching additional posts dude! ");
          this._page += 1;
          this.$.postsFetcher.path = 'blogs/' + this.blog.instanceId + '/posts?page=' + this._page + ';1';
          this.$.postsFetcher.send();
        }
      },
      _renderPostsAtGivenDate: function(event) {
        var date = event.detail, _posts = [];
        for (var i = 0; i < this._allPosts.length; i++) {
          var currentDate = new Date(this._allPosts[i].dateEvent);
          if (currentDate.getMonth() === date.getMonth() &&
              currentDate.getYear() === date.getYear() &&
              currentDate.getDate() === date.getDate()) {
            _posts.push(this._allPosts[i]);
          }
        }
        console.log("posts to render: " + _posts.length);
        if (!this._dateSelected) {
          this._previousPosts = this.posts;
          this._dateSelected = true;
        }
        this._setPosts(_posts);
      },
      _renderPreviousAllPosts: function(event) {
        this._setPosts(this._previousPosts);
        this._previousPosts = null;
        this._dateSelected = false;
      }
    });
  </script>
</dom-module>