<dom-module id="sp-blog-home">
  <template>
    <sp-i18n key="post" message="{{postLabel}}" hidden></sp-i18n>
    <sp-notifier id="postNotFound" type="error">
      <sp-i18n key="error.blog.post.not.found">
        <sp-i18n-param><b><span>{{msgPostUri}}</span></b></sp-i18n-param>
      </sp-i18n>
    </sp-notifier>
    <sp-notifier id="createSuccess" type="success">
      <sp-i18n key="message.contribution.create.success" params="[[postLabel]]"></sp-i18n>
    </sp-notifier>
    <sp-notifier id="updateSuccess" type="success">
      <sp-i18n key="message.contribution.update.success" params="[[postLabel]]"></sp-i18n>
    </sp-notifier>
    <sp-app-instance-layout on-post-selected="_viewPost">
      <iron-pages class="app-main" attr-for-selected="data-page" selected="{{page}}" activate-event="">
        <section data-page="blog-home" class="blog with-aside-app">
          <sp-post-list blog="[[blog]]"></sp-post-list>
        </section>
        <section data-page="post-info" class="blog with-aside-app">
          <sp-post-view post="[[selectedPost]]" class="publication"></sp-post-view>
        </section>
        <section data-page="post-edition" class="blog with-aside-app">
          <sp-post-edition post="[[selectedPost]]"
                           created-flag="{{_created}}"
                           updated-flag="{{_updated}}"></sp-post-edition>
        </section>
      </iron-pages>
    </sp-app-instance-layout>
  </template>

  <script>
    Polymer({
      is : 'sp-blog-home',

      behaviors : [NavigationContextBehavior, SilverpeasServiceAjaxBehavior,
        ApplicationInstanceBehavior, BlogBehavior, i18nBehavior],

      properties : {

        context : {
          type : Object
        },

        _created : {
          type : Boolean, observer : '_onCreatedChange'
        },

        _updated : {
          type : Boolean, observer : '_onUpdatedChange'
        }
      },

      observers : ['_onContextChange(context.instance.model, context.instance.page)'],

      _viewPost : function(e) {
        e.preventDefault();
        e.stopPropagation();
        page(this.getPostViewUrl(e.detail.post), e.detail.post);
      },

      _onContextChange : function() {
        if (this.context.instance.model && this.context.instance.id.indexOf('blog') === 0) {
          if (this.context.instance.page) {
            if (this.context.instance.page.id === 'new') {
              this.selectedPost = {
                id : null,
                componentId : this.context.instance.id,
                title : '',
                content : '',
                updateDate : new Date().getTime(),
                dateEvent : new Date().getTime(),
                createDate : new Date().getTime()
              };
              this.setContextPageInfo({label : this.i18n("blog.title.new.label")});
              this.page = 'post-edition';
            } else {
              var postUri = this.getPostUriFromContext(this.context);
              this.newSilverpeasServiceAjax().onResponse(function(event) {
                this.selectedPost = event.detail.response;
                this.setContextPageInfo({label : this.selectedPost.title});
                var _page = 'post-info';
                for (var i = 0; i < this.context.instance.page.params.length; i++) {
                  if (this.context.instance.page.params[i].key === 'state') {
                    switch (this.context.instance.page.params[i].value) {
                      case 'edition':
                        _page = 'post-edition';
                        break;
                    }
                    break;
                  }
                }
                this.page = _page;
              }.bind(this)).onError(function() {
                this.msgPostUri = postUri;
                page(this.getApplicationInstancePageUrl(this.context.instance.id));
                this.$.postNotFound.show();
              }.bind(this)).get(postUri);
            }
          } else {
            this.blog = this.context.instance.model;
            this.page = 'blog-home';
          }
        }
      },

      _onCreatedChange : function() {
        if (this._created) {
          this.$.createSuccess.show();
        }
      },

      _onUpdatedChange : function() {
        if (this._updated) {
          this.$.updateSuccess.show();
        }
      }
    });
  </script>

</dom-module>
