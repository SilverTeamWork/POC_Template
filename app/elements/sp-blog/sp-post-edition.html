<dom-module id="sp-post-edition">
  <style>
    .title, .buttonBar {
      margin-top: 15px;
      margin-bottom: 15px;
    }
  </style>
  <template>
    <sp-i18n key="post" message="{{postLabel}}" hidden></sp-i18n>
    <sp-notifier id="createError" type="error">
      <sp-i18n key="message.contribution.create.error" params="[[postLabel]]"></sp-i18n>
    </sp-notifier>
    <sp-notifier id="updateError" type="error">
      <sp-i18n key="message.contribution.update.error" params="[[postLabel]]"></sp-i18n>
    </sp-notifier>
    <sp-notifier id="titleError" type="error">
      <sp-i18n key="error.blog.post.title.empty.error"></sp-i18n>
    </sp-notifier>
    <sp-service-ajax
      id="request"
      path="[[postUrl]]"
      method="[[editionMethod]]"
      content-type="application/json"
      handle-as="json"
      body="[[post]]"
      on-response="_success"
      on-error="_error">
    </sp-service-ajax>

    <sp-app-instance-header title="[[_title]]"></sp-app-instance-header>

    <sp-app-instance-right-panel>
      <sp-date-picker id="datePicker" locale="[[_locale]]"></sp-date-picker>
    </sp-app-instance-right-panel>

    <form id="edition">
      <fieldset>
        <div>
          <input type="text" class="title w100" value="{{_title::input}}">
        </div>
        <sp-wysiwyg text="[[_content]]"></sp-wysiwyg>
        <div class="buttonBar txtcenter">
          <div class="buttonSet">
            <paper-button value="[[cancelLabel]]" dialog-dismiss autofocus on-click="_cancel" class="button btn" type="submit">
              <sp-i18n key="action.cancel" message="{{cancelLabel}}"></sp-i18n>
            </paper-button>
            <paper-button value="[[validateLabel]]" dialog-confirm on-click="_submit" class="button btn" type="submit">
              <sp-i18n key="action.validate" message="{{validateLabel}}"></sp-i18n>
            </paper-button>
          </div>
        </div>
      </fieldset>
    </form>
  </template>

  <script>
    Polymer({
      is : 'sp-post-edition',

      behaviors: [i18nBehavior],

      properties : {
        post : {
          type : Object,
          observer : '_onPostChange'
        },
        createdFlag: {
          type: Boolean,
          value: false,
          notify: true,
          readOnly: true
        },
        updatedFlag: {
          type: Boolean,
          value: false,
          notify: true,
          readOnly: true
        },
        postUrl: {
          type: String,
          computed: '_computePostUrl(post)'
        },
        editionMethod: {
          type: String,
          computed: '_computeEditionMethod(post)'
        },
        _title : {
          type : String,
          value: null,
          observer : '_onTitleChange'
        }
      },
      ready: function() {
        this._locale = this.i18nUserLanguage;
      },
      _onTitleChange : function() {
        if (this.post && this.post.id === null && !this._title.length) {
          this._title = this.i18n("blog.title.new.label");
        }
      },
      _onPostChange : function() {
        this._creationRequest = this.post && this.post.id === null;
        console.log((this._creationRequest ? "create new post":"edit post " + this.post.id + ": " + this.post.title));
        this._title = this.post.title;
        this._content = this.post.content;
        this.$.datePicker.event = this.post.id ? new Date(this.post.dateEvent) : new Date();
      },
      _cancel: function() {
        page('/instances/' + this.post.componentId);
      },
      _computePostUrl: function(post) {
        return 'blogs/' + post.componentId + '/posts/' + (this.post.id === null ? '':this.post.id);
      },
      _computeEditionMethod: function(post) {
        return (this.post.id === null ? 'POST':'PUT');
      },
      _submit: function() {
        if (this._title && this._title.trim().length > 0) {
          this.post.title = this._title;
          this.post.content = this.$$('sp-wysiwyg').getText();
          this.$.request.send();
        } else {
          this.$.titleError.show();
        }
      },
      _success: function() {
        if (this._creationRequest) {
          this._setCreatedFlag(true);
        } else {
          this._setUpdatedFlag(true);
        }
        page('/instances/' + this.post.componentId);
      },
      _error: function() {
        if (this._creationRequest) {
          this._setCreatedFlag(false);
          this.$.createError.show();
        } else {
          this._setUpdatedFlag(false);
          this.$.updateError.show();
        }
      }
    });
  </script>
</dom-module>