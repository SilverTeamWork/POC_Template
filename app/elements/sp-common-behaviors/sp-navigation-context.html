<script>
  (function() {

    var __handleCommonRouteData = function(context, data) {
      context.setAndNotify('path', data.path);
    };

    var __clearSpaceContext = function(context, space) {
      var spaceValue = (space) ? space : null;
      context.setAndNotify('space', {model : spaceValue});
    };

    var __clearApplicationContext = function(context) {
      context.setAndNotify('instance', {});
    };

    var __context;

    window.NavigationContextBehavior = {

      init : function(host) {
        __context = {

          /**
           * Sets the context data about a space access.
           * @param routeData the parameters about a space access.
           * @returns {NavigationContextBehavior} the context itself.
           */
          ofSpace : function(routeData) {
            __handleCommonRouteData(this, routeData);
            __clearApplicationContext(this);
            this.setAndNotify('space', {id : routeData.params.id});
            host.route = 'space-home';
            return this;
          },

          /**
           * Sets the context space object.
           * @param space a well loaded space.
           * @returns {NavigationContextBehavior} the context itself.
           */
          setCurrentSpace : function(space) {
            this.setAndNotify('space.model', space);
            return this;
          },

          /**
           * Sets the context data about an application instance (and its internal page) access.
           * @param routeData the parameters about an application instance (and its internal page) access.
           * @returns {NavigationContextBehavior} the context itself.
           */
          ofApplicationInstance : function(routeData) {
            __clearSpaceContext(this);
            __handleCommonRouteData(this, routeData);
            var instance = {
              id : routeData.params.id, model : null, page : null
            };
            if (routeData.params.resource && routeData.params.rid) {
              var params = [];
              if (routeData.querystring) {
                var pairs = routeData.querystring.split('&');
                for (var i = 0; i < pairs.length; i++) {
                  var param = pairs[i].split('=');
                  params.push({key : param[0], value : param[1]});
                }
              }
              instance.page = {
                type : routeData.params.resource, id : routeData.params.rid, params : params
              };
            }
            this.setAndNotify('instance', instance);
            host.route = 'instance-home';
            return this;
          },

          /**
           * Sets the context application instance object.
           * @param instance a well loaded application instance.
           * @returns {NavigationContextBehavior} the context itself.
           */
          setCurrentApplicationInstance : function(instance) {
            this.setAndNotify('instance.model', instance);
            return this;
          },

          /**
           * Sets the context data about an application instance (and its internal page) access.
           * @param routeData the parameters about an application instance (and its internal page) access.
           * @returns {NavigationContextBehavior} the context itself.
           */
          ofUnknown : function(routeData) {
            if (routeData.canonicalPath.indexOf('/#!') === 0) {
              var indexOfBadPath = routeData.path.indexOf('//');
              if (0 <= indexOfBadPath && indexOfBadPath <= 1) {
                var path = routeData.path.replace(/^\/{2,}/gi, '/');
                console.log(path);
                page.show(path, routeData.state);
              }
            } else {
              __clearApplicationContext(this);
              __clearSpaceContext(this, SpaceBehavior.properties.homeSpace.value);
              __handleCommonRouteData(this, routeData);
              host.route = 'home';
            }
            return this;
          },

          /**
           * Sets page info data (used by breadcrumb for example).
           * @param pageInfo the page info.
           * @returns {NavigationContextBehavior} the context itself.
           */
          setPageInfo : function(pageInfo) {
            var _pageInfo = $S.extend({label : ''}, pageInfo);
            this.setAndNotify('instance.page.label', _pageInfo.label);
            return this;
          },

          /**
           * Sets the attribute value of the context from given path and value.
           * @param contextAttributeName the path
           * @param value the value to set.
           * @returns {NavigationContextBehavior} the context itself.
           */
          setAndNotify : function(contextAttributeName, value) {
            var attribute = this;
            var contextPathParts = contextAttributeName.split(".");
            contextPathParts.forEach(function(part, index) {
              if ((index + 1) == contextPathParts.length) {
                if (attribute[part] == value) {
                  console.log("Trying to notify binding 'context." + contextAttributeName +
                      "', but value has not changed... ('" + value + "')");
                }
                attribute[part] = value;
              } else {
                attribute = attribute[part] || {};
              }
            });
            host.notifyPath('context.' + contextAttributeName, value);
            return this;
          },

          reset : function() {
            this.path = null;
            this.space = {};
            this.instance = {};
            return this;
          }
        }.reset();

        return __context;
      },

      /**
       * Sets the context space object.
       * @param space a well loaded space.
       */
      setContextSpace : function(space) {
        __context.setCurrentSpace(space);
      },

      /**
       * Sets the context application instance object.
       * @param applicationInstance a well loaded application instance.
       */
      setContextApplicationInstance : function(applicationInstance) {
        __context.setCurrentApplicationInstance(applicationInstance);
      },

      /**
       * Sets page info data (used by breadcrumb for example).
       * @param pageInfo the page info.
       */
      setContextPageInfo : function(pageInfo) {
        __context.setPageInfo(pageInfo);
      }
    };
  })();
</script>