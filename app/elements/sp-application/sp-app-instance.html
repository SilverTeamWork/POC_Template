<dom-module id="sp-app-instance">
  <template>
    <sp-service-ajax id="requester"
                     path="[[getApplicationInstanceUri(instanceId)]]"
                     last-response="{{applicationInstance}}"
                     on-error="_applicationInstanceNotFound"></sp-service-ajax>
    <template is="dom-if" if="{{isApplicationNameEqualTo(applicationInstance, 'blog')}}">
      <sp-blog-home blog="{{instanceId}}"></sp-blog-home>
    </template>

    <template is="dom-if" if="{{_isApplicationNotHandled(applicationInstance)}}">
      <div>Application <b><span>{{applicationInstance.name}}</span></b> is not yet handled.</div>
    </template>

    <template is="dom-if" if="{{!isApplicationInstanceFound}}">
      <div>Application with identifier <b><span>{{instanceId}}</span></b> does not exist, asshole.
      </div>
    </template>
  </template>
</dom-module>
<script>
  (function() {

    Polymer({
      is : 'sp-app-instance',

      behaviors : [ApplicationInstanceBehavior],

      properties : {

        instanceId : {
          type : String, notify : true, observer : '_instanceIdChanged'
        },

        applicationInstance : {
          type : Object, notify : true, observer : '_applicationInstanceChanged'
        },

        isApplicationInstanceFound : {
          type : Boolean, notify : true, readOnly : true
        }
      },

      created : function() {
        this.handledApplications = [];
        var map = this.handledApplications;
        map['blog'] = true;
      },

      _instanceIdChanged : function() {
        if (this.isValidApplicationInstanceId(this.instanceId)) {
          this.$.requester.send();
        }
      },

      _applicationInstanceNotFound : function() {
        this.applicationInstance = null;
        this._applicationInstanceChanged();
      },

      _applicationInstanceChanged : function() {
        this._setIsApplicationInstanceFound(this.isValidApplicationInstance(this.applicationInstance));
        this.fire('iron-signal', {
          name : 'last-accessed-application-instance', data : {
            applicationInstance : this.applicationInstance
          }
        });
      },

      _isApplicationNotHandled : function(applicationInstance) {
        return this.isValidApplicationInstance(applicationInstance) &&
            !this.handledApplications[applicationInstance.name];
      },

      _isApplicationNotFound : function(lastError) {
        return (typeof lastError === 'object');
      }
    });
  })();
</script>
