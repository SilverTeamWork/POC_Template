<link rel="import" href="../sp-space/sp-space-libs.html">
<link rel="import" href="../sp-breadcrumb/sp-breadcrumb.html">

<dom-module id="sp-app-instance">
  <template>
    <sp-notifier id="msgNotHandled" type="warning">
      L'application <b><span>{{msgInstanceName}}</span></b> n'est pas encore prise en charge.
    </sp-notifier>
    <sp-notifier id="msgNotFound" type="error">
      Il n'existe pas d'instance d'application ayant l'identifiant <b><span>{{msgInstanceId}}</span></b>.
    </sp-notifier>

    <sp-service-ajax id="applicationInstanceRequester"
                     path="[[getApplicationInstanceUri(instanceId)]]"
                     last-response="{{applicationInstance}}"
                     on-error="_applicationInstanceNotFound"></sp-service-ajax>

    <div class="main wrapper flexitem-fluid flexbox-h">
      <sp-space-menu class="flexbox-v" space="{{parentSpace}}"></sp-space-menu>
      <div class="main wrapper flexitem-fluid application">
        <section data-field="app-section" class="with-aside-app">
          <sp-breadcrumb></sp-breadcrumb>
          <header>
            <h2 class="title"><span id="title">{{applicationInstance.label}}</span></h2>
            <aside id="applicationMenu" class="menu actions"></aside>
            <p id="description">{{applicationInstance.description}}</p>
          </header>

          <!--<aside class="aside-app" id="aside-app-fixed">-->
          <!--<img src="../../images/calendar-magie-mai.png" alt="calendrier"/>-->
          <!--</aside>-->

          <div class="application-content">
            <template is="dom-if" if="{{isApplicationNameEqualTo(applicationInstance, 'blog')}}">
              <sp-blog-home blog="{{instanceId}}"></sp-blog-home>
            </template>
          </div>

          <footer>
            <div class="application-footer">--</div>
          </footer>
        </section>
      </div>
    </div>
  </template>
</dom-module>
<script>
  (function() {

    Polymer({
      is : 'sp-app-instance',

      behaviors : [SpaceBehavior, ApplicationInstanceBehavior],

      properties : {

        instanceId : {
          type : String, notify : true, observer : '_instanceIdChanged'
        },

        applicationInstance : {
          type : Object, notify : true, observer : '_applicationInstanceChanged'
        },

        isApplicationInstanceFound : {
          type : Boolean, notify : true, readOnly : true
        }
      },

      created : function() {
        this.handledApplications = [];
        var map = this.handledApplications;
        map['blog'] = true;
      },

      ready : function() {
        document.body.addEventListener('last-accessed-space', function(e) {
          // When a space homepage is accessed, this page must be cleared in order to get a right behavior!
          this.instanceId = null;
        }.bind(this));
      },

      _instanceIdChanged : function() {
        this.$.msgNotHandled.hide();
        this.$.msgNotFound.hide();
        if (this.isValidApplicationInstanceId(this.instanceId)) {
          this.$.applicationInstanceRequester.send();
        }
      },

      _applicationInstanceNotFound : function() {
        this.applicationInstance = null;
        this.msgInstanceId = this.instanceId;
        this.$.msgNotFound.show();
        this._applicationInstanceChanged();
      },

      _applicationInstanceChanged : function() {
        this._setIsApplicationInstanceFound(this.isValidApplicationInstance(this.applicationInstance));
        if (this.isApplicationInstanceFound) {
          this._loadParentSpaces(this.applicationInstance, function() {
            this.parentSpace = this.applicationInstance.parentSpace;
            this.fire('last-accessed-application-instance', this.applicationInstance);
          });
          this._verifyApplicationNotHandled();
        } else {
          this.fire('last-accessed-application-instance', this.applicationInstance);
        }
      },

      _verifyApplicationNotHandled : function() {
        var isNotHandled = this.isValidApplicationInstance(this.applicationInstance) &&
            !this.handledApplications[this.applicationInstance.name];
        if (isNotHandled) {
          this.msgInstanceName = this.applicationInstance.label;
          this.$.msgNotHandled.show();
        }
        return isNotHandled;
      },

      _isApplicationNotFound : function(lastError) {
        return (typeof lastError === 'object');
      }
    });
  })();
</script>
